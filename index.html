<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Aulas - Universidade LAMIC</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
            color: #1a2b49;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        header {
            width: 100%;
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, #1a2b49, #2c4373);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        header h1 {
            margin: 0;
            font-size: clamp(1.8em, 5vw, 2.4em);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .change-category-btn {
            background-color: #4a90e2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(0.9em, 2vw, 1em);
            font-weight: 600;
            margin: 10px 0;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .change-category-btn:hover {
            background-color: #2c4373;
            transform: scale(1.05);
        }
        .tabs {
            width: 90%;
            max-width: 1200px;
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tab-btn {
            background-color: #1a2b49;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(0.9em, 2vw, 1em);
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .tab-btn:hover {
            background-color: #2c4373;
            transform: scale(1.05);
        }
        .tab-btn.active {
            background-color: #4a90e2;
        }
        .tab-content {
            display: none !important;
            width: 90%;
            max-width: 1200px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }
        .tab-content.active {
            display: block !important;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        .form-container label {
            font-size: clamp(0.9em, 2vw, 1em);
            font-weight: 600;
            color: #1a2b49;
        }
        .form-container input, .form-container select, .form-container textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: clamp(0.9em, 2vw, 1em);
            transition: border-color 0.3s ease;
        }
        .form-container input:focus, .form-container select:focus, .form-container textarea:focus {
            border-color: #1a2b49;
            outline: none;
        }
        .form-container button {
            background-color: #1a2b49;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(0.9em, 2vw, 1em);
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .form-container button:hover {
            background-color: #2c4373;
            transform: scale(1.05);
        }
        .form-container button.delete {
            background-color: #dc3545;
        }
        .form-container button.delete:hover {
            background-color: #c82333;
        }
        .modules-container, .subjects-container, .themes-container, .quizzes-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .module-card, .subject-card, .theme-card, .quiz-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .module-card:hover, .subject-card:hover, .theme-card:hover, .quiz-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        .module-card h3, .subject-card h3, .theme-card h3, .quiz-card h3 {
            margin: 0 0 10px;
            font-size: clamp(1.1em, 2.5vw, 1.3em);
            font-weight: 600;
            color: #1a2b49;
        }
        .module-card p, .subject-card p, .theme-card p, .quiz-card p {
            margin: 5px 0;
            font-size: clamp(0.85em, 2vw, 0.95em);
            color: #4a5b7a;
        }
        .module-card button, .subject-card button, .theme-card button, .quiz-card button {
            margin-top: 10px;
            width: 100%;
        }
        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .card-actions button {
            flex: 1;
            margin-top: 0;
        }
        .order-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .order-btn {
            flex: 1;
            background-color: #6c757d;
            color: white;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .order-btn:hover {
            background-color: #5a6268;
            transform: scale(1.05);
        }
        .order-btn:disabled {
            background-color: #c6c8ca;
            cursor: not-allowed;
            transform: none;
        }
        .migrate-container {
            display: none;
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #dee2e6;
        }
        .migrate-container.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .migrate-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #1a2b49;
        }
        .migrate-header i {
            font-size: 1.3em;
            color: #ff9800;
        }
        .migrate-header h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 600;
        }
        .migrate-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .migrate-select-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .migrate-select-wrapper label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95em;
        }
        .migrate-select-wrapper select {
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: white;
        }
        .migrate-select-wrapper select:focus {
            border-color: #ff9800;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }
        .migrate-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }
        .migrate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        .migrate-btn:active {
            transform: translateY(0);
        }
        .warning-message {
            display: none;
            background: linear-gradient(135deg, #2b82b4, #4096b1);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: clamp(1em, 2.5vw, 1.2em);
            font-weight: 600;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: warningPop 0.5s ease-in-out;
        }
        @keyframes warningPop {
            0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.1); opacity: 0.8; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
        .loading-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a2b49;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-in-out;
        }
        .modal-content.error {
            animation: shake 0.5s ease-in-out;
            border: 2px solid #dc3545;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .modal-content label {
            font-size: clamp(0.9em, 2vw, 1em);
            font-weight: 600;
            color: #1a2b49;
            margin-bottom: 5px;
            display: block;
        }
        .modal-content select, .modal-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: clamp(0.9em, 2vw, 1em);
            margin-bottom: 15px;
        }
        .modal-content button {
            background-color: #1a2b49;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(0.9em, 2vw, 1em);
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s ease;
        }
        .modal-content button:hover {
            background-color: #2c4373;
        }
        .lockout-message {
            display: none;
            text-align: center;
            margin-bottom: 15px;
            color: #dc3545;
            font-weight: 600;
        }
        .progress-bar-container {
            width: 100%;
            background: #f3f3f3;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar {
            height: 10px;
            background: #dc3545;
            width: 0%;
            transition: width 10s linear;
        }
        @media (max-width: 600px) {
            .tabs {
                flex-direction: column;
                align-items: center;
            }
            .tab-btn {
                width: 100%;
                padding: 10px;
            }
            .modules-container, .subjects-container, .themes-container, .quizzes-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="modal" id="category-modal">
        <div class="modal-content" id="modal-content">
            <h2>Selecionar Categoria</h2>
            <div class="lockout-message" id="lockout-message">Aguarde para tentar novamente</div>
            <div class="progress-bar-container" id="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <label for="category-select">Categoria</label>
            <select id="category-select">
                <option value="">Selecione uma categoria</option>
                <option value="Treinamentos">Treinamentos</option>
                <option value="Educação Continuada">Educação Continuada</option>
                <option value="Estágios">Estágios</option>
            </select>
            <label for="password-input">Senha</label>
            <input type="password" id="password-input" placeholder="Digite a senha">
            <button id="category-submit">Entrar</button>
        </div>
    </div>

    <header>
        <h1><i class="fas fa-graduation-cap"></i> Gerenciador de Aulas - Universidade LAMIC</h1>
        <button class="change-category-btn" id="change-category-btn">Trocar de Categoria</button>
    </header>

    <div class="warning-message" id="warning-message">
        <span id="warning-text"></span>
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-tab="subjects">Temas</button>
        <button class="tab-btn" data-tab="themes">Assuntos</button>
        <button class="tab-btn" data-tab="modules">Módulos</button>
        <button class="tab-btn" data-tab="quizzes">Avaliações</button>
    </div>

    <!-- Aba de Temas -->
    <div class="tab-content active" id="subjects-tab">
        <div class="form-container">
            <h2>Gerenciar Temas</h2>
            <label for="subject-name">Nome do Tema</label>
            <input type="text" id="subject-name" placeholder="Digite o nome do tema">
            <button id="subject-save">Salvar Tema</button>
            <button id="subject-delete" class="delete" style="display: none;">Excluir Tema</button>
            <div id="subject-loading" class="loading-spinner"></div>
            <h3 style="margin-top: 20px;">Temas Existentes</h3>
            <div id="subjects-container" class="subjects-container"></div>
        </div>
    </div>

    <!-- Aba de Assuntos -->
    <div class="tab-content" id="themes-tab">
        <div class="form-container">
            <h2>Gerenciar Assuntos</h2>
            <label for="theme-subject">Selecionar Tema</label>
            <select id="theme-subject">
                <option value="">Selecione um tema</option>
            </select>
            <label for="theme-name">Nome do Assunto</label>
            <input type="text" id="theme-name" placeholder="Digite o nome do assunto">
            <button id="theme-save">Salvar Assunto</button>
            <button id="theme-delete" class="delete" style="display: none;">Excluir Assunto</button>
            <div id="theme-migrate-container" class="migrate-container">
                <div class="migrate-header">
                    <i class="fas fa-exchange-alt"></i>
                    <h3>Migrar Assunto</h3>
                </div>
                <div class="migrate-content">
                    <div class="migrate-select-wrapper">
                        <label for="theme-new-subject">Selecione o novo tema de destino</label>
                        <select id="theme-new-subject">
                            <option value="">Selecione o novo tema</option>
                        </select>
                    </div>
                    <button id="theme-migrate" class="migrate-btn">
                        <i class="fas fa-arrow-right"></i>
                        <span>Migrar Assunto (com Módulos e Avaliações)</span>
                    </button>
                </div>
            </div>
            <div id="theme-loading" class="loading-spinner"></div>
            <h3 style="margin-top: 20px;">Assuntos Existentes</h3>
            <div id="themes-container" class="themes-container"></div>
        </div>
    </div>

    <!-- Aba de Módulos -->
    <div class="tab-content" id="modules-tab">
        <div class="form-container">
            <h2>Gerenciar Módulos</h2>
            <label for="module-subject">Selecionar Tema</label>
            <select id="module-subject">
                <option value="">Selecione um tema</option>
            </select>
            <label for="module-theme">Selecionar Assunto</label>
            <select id="module-theme">
                <option value="">Selecione um assunto</option>
            </select>
            <div id="modules-container" class="modules-container"></div>
            <h3 style="margin-top: 20px;">Adicionar/Editar Módulo</h3>
            <label for="module-title">Título do Módulo</label>
            <input type="text" id="module-title" placeholder="Digite o título do módulo">
            <label for="module-caption">Subtítulo (Descrição)</label>
            <textarea id="module-caption" placeholder="Digite a descrição do módulo"></textarea>
            <label for="module-video">ID do Vídeo (YouTube)</label>
            <input type="text" id="module-video" placeholder="Ex.: dQw4w9WgXcQ">
            <label for="module-pdf">Diretório do PDF</label>
            <input type="text" id="module-pdf" placeholder="Código após dropbox.com/scl/fi/(Código) Ex.: Código&dl=1">
            <label for="module-attachments">Anexos (título;URL, um por linha)</label>
            <textarea id="module-attachments" placeholder="Ex.: Guia;https://example.com/guia.pdf"></textarea>
            <button id="module-save">Salvar Módulo</button>
            <button id="module-delete" class="delete" style="display: none;">Excluir Módulo</button>
            <div id="module-loading" class="loading-spinner"></div>
        </div>
    </div>

    <!-- Aba de Avaliações -->
    <div class="tab-content" id="quizzes-tab">
        <div class="form-container">
            <h2>Gerenciar Avaliações</h2>
            <label for="quiz-subject">Selecionar Tema</label>
            <select id="quiz-subject">
                <option value="">Selecione um tema</option>
            </select>
            <label for="quiz-theme">Selecionar Assunto</label>
            <select id="quiz-theme">
                <option value="">Selecione um assunto</option>
            </select>
            <div id="quizzes-container" class="quizzes-container"></div>
            <h3 style="margin-top: 20px;">Adicionar/Editar Questão</h3>
            <label for="quiz-question">Pergunta</label>
            <input type="text" id="quiz-question" placeholder="Digite a pergunta">
            <label for="quiz-option1">Opção 1</label>
            <input type="text" id="quiz-option1" placeholder="Digite a opção 1">
            <label for="quiz-option2">Opção 2</label>
            <input type="text" id="quiz-option2" placeholder="Digite a opção 2">
            <label for="quiz-option3">Opção 3</label>
            <input type="text" id="quiz-option3" placeholder="Digite a opção 3">
            <label for="quiz-option4">Opção 4</label>
            <input type="text" id="quiz-option4" placeholder="Digite a opção 4">
            <label for="quiz-correct">Opção Correta</label>
            <select id="quiz-correct">
                <option value="0">Opção 1</option>
                <option value="1">Opção 2</option>
                <option value="2">Opção 3</option>
                <option value="3">Opção 4</option>
            </select>
            <button id="quiz-save">Salvar Questão</button>
            <button id="quiz-delete" class="delete" style="display: none;">Excluir Questão</button>
            <div id="quiz-loading" class="loading-spinner"></div>
        </div>
    </div>

    <script>
        const bins = {
            'Treinamentos': '68d7d3e5ae596e708ffdae68',
            'Educação Continuada': '68d7dfc243b1c97be951fccc',
            'Estágios': '68d7d3e5ae596e708ffdae68'
        };
        const masterKey = '$2a$10$2elKW8TT6o.K3V176efqwu7kOfD1PnS3D/F0s4Tczc3MYmaU.N1bi';
        const passwordBinId = '68d7e57bd0ea881f408cf33b';
        let currentBinId = null;
        let apiUrl = null;
        let data = { trainingData: {}, quizData: {} };
        let currentSubjectId = null;
        let currentThemeId = null;
        let currentModuleIndex = null;
        let currentQuizIndex = null;
        let loginAttempts = 0;
        let isLocked = false;

        // Função para inicializar abas corretamente
        function initializeTabs() {
            const allTabButtons = document.querySelectorAll('.tab-btn');
            const allTabContents = document.querySelectorAll('.tab-content');
            
            // Remover active de todas as abas
            allTabButtons.forEach(btn => btn.classList.remove('active'));
            allTabContents.forEach(content => content.classList.remove('active'));
            
            // Ativar apenas a aba de subjects
            const subjectsBtn = document.querySelector('.tab-btn[data-tab="subjects"]');
            const subjectsTab = document.getElementById('subjects-tab');
            if (subjectsBtn) subjectsBtn.classList.add('active');
            if (subjectsTab) subjectsTab.classList.add('active');
        }

        // Funções de utilidade
        function showWarning(message) {
            const warningMessage = document.getElementById('warning-message');
            const warningText = document.getElementById('warning-text');
            warningText.textContent = message;
            warningMessage.style.display = 'block';
            setTimeout(() => {
                warningMessage.style.display = 'none';
            }, 3000);
        }

        function showModal() {
            document.getElementById('category-modal').style.display = 'flex';
            document.getElementById('category-select').value = '';
            document.getElementById('password-input').value = '';
            document.getElementById('modal-content').classList.remove('error');
            document.getElementById('lockout-message').style.display = 'none';
            document.getElementById('progress-bar-container').style.display = 'none';
            document.getElementById('category-submit').disabled = isLocked;
        }

        function hideModal() {
            document.getElementById('category-modal').style.display = 'none';
        }

        async function validatePassword(password) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${passwordBinId}/latest`, {
                    headers: { 'X-Master-Key': masterKey }
                });
                if (!response.ok) {
                    console.error(`Erro ao acessar JSONBin de senha: Status ${response.status}`);
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const json = await response.json();
                if (!json.record || !json.record.password) {
                    console.error('Estrutura do JSON de senha inválida:', json);
                    throw new Error('Estrutura do JSON de senha inválida');
                }
                return json.record.password === password;
            } catch (error) {
                console.error('Erro ao validar senha:', error.message);
                showWarning('Erro ao verificar senha. Tente novamente.');
                return false;
            }
        }

        function startLockout() {
            isLocked = true;
            loginAttempts = 0;
            const lockoutMessage = document.getElementById('lockout-message');
            const progressBar = document.getElementById('progress-bar');
            const progressBarContainer = document.getElementById('progress-bar-container');
            lockoutMessage.style.display = 'block';
            progressBarContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.style.transition = 'width 10s linear';
            setTimeout(() => {
                progressBar.style.width = '100%';
            }, 0);
            setTimeout(() => {
                isLocked = false;
                lockoutMessage.style.display = 'none';
                progressBarContainer.style.display = 'none';
                progressBar.style.transition = 'none';
                progressBar.style.width = '0%';
                document.getElementById('category-submit').disabled = false;
            }, 10000);
        }

        document.getElementById('category-submit').addEventListener('click', async () => {
            if (isLocked) return;
            const category = document.getElementById('category-select').value;
            const password = document.getElementById('password-input').value;
            if (!category) {
                showWarning('Por favor, selecione uma categoria.');
                return;
            }
            if (!password) {
                showWarning('Por favor, insira a senha.');
                return;
            }
            const isValid = await validatePassword(password);
            const modalContent = document.getElementById('modal-content');
            if (!isValid) {
                loginAttempts++;
                modalContent.classList.add('error');
                showWarning('Senha incorreta.');
                setTimeout(() => modalContent.classList.remove('error'), 500);
                if (loginAttempts >= 5) {
                    startLockout();
                }
                return;
            }
            currentBinId = bins[category];
            apiUrl = `https://api.jsonbin.io/v3/b/${currentBinId}`;
            loginAttempts = 0;
            hideModal();
            await fetchData();
        });

        document.getElementById('change-category-btn').addEventListener('click', () => {
            showModal();
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        });

        async function fetchData() {
            if (!apiUrl) {
                console.error('apiUrl não definido ao tentar carregar dados');
                return;
            }
            try {
                const response = await fetch(`${apiUrl}/latest`, {
                    headers: { 'X-Master-Key': masterKey }
                });
                if (!response.ok) {
                    console.error(`Erro ao carregar dados do bin ${currentBinId}: Status ${response.status}`);
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                data = result.record || { trainingData: {}, quizData: {} };
                initializeOrder();
                populateSubjectSelects();
                populateSubjects();
                populateThemes();
                populateModules();
                populateQuizzes();
                // Garantir que todas as abas estejam desativadas antes de ativar a inicial
                tabButtons.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                // Ativar apenas a aba de subjects
                const subjectsBtn = document.querySelector('.tab-btn[data-tab="subjects"]');
                const subjectsTab = document.getElementById('subjects-tab');
                if (subjectsBtn) subjectsBtn.classList.add('active');
                if (subjectsTab) subjectsTab.classList.add('active');
            } catch (error) {
                console.error('Erro ao carregar dados:', error.message);
                showWarning('Não foi possível carregar os dados. Tente novamente.');
                showModal();
            }
        }

        async function saveData() {
            if (!apiUrl) {
                console.error('apiUrl não definido ao tentar salvar dados');
                showWarning('Nenhum bin selecionado. Selecione uma categoria.');
                return false;
            }
            try {
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': masterKey
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Erro ao salvar dados no bin ${currentBinId}: Status ${response.status}, Detalhes: ${errorText}`);
                    throw new Error(`HTTP error! Status: ${response.status}, Detalhes: ${errorText}`);
                }
                console.log(`Dados salvos com sucesso no bin ${currentBinId}`);
                return true;
            } catch (error) {
                console.error('Erro ao salvar dados:', error.message);
                showWarning(`Não foi possível salvar os dados: ${error.message}`);
                return false;
            }
        }

        function showSpinner(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
        }

        function getNextId(obj) {
            const ids = Object.keys(obj).map(Number).filter(id => !isNaN(id));
            return ids.length ? Math.max(...ids) + 1 : 1;
        }

        // Funções auxiliares para ordenação
        function getOrderedIds(obj) {
            initializeOrder();
            // Sempre usar a ordem do JSON (data.order.subjects)
            // Se não houver ordem salva ou se estiver vazia, inicializar com a ordem natural
            if (!data.order.subjects || data.order.subjects.length === 0) {
                const naturalOrder = Object.keys(obj).map(Number).sort((a, b) => a - b);
                data.order.subjects = naturalOrder;
                return naturalOrder;
            }
            // Retorna a ordem do JSON, filtrando IDs que não existem mais e adicionando novos
            const existingIds = Object.keys(obj).map(Number);
            const savedOrder = data.order.subjects.filter(id => existingIds.includes(id));
            // Adicionar IDs novos que não estão na ordem salva
            existingIds.forEach(id => {
                if (!savedOrder.includes(id)) {
                    savedOrder.push(id);
                }
            });
            // Atualizar a ordem no JSON
            data.order.subjects = savedOrder;
            return savedOrder;
        }

        function getOrderedThemeIds(subjectId) {
            initializeOrder();
            const themes = data.trainingData[subjectId]?.themes || {};
            // Sempre usar a ordem do JSON
            if (!data.order.themes[subjectId] || data.order.themes[subjectId].length === 0) {
                const naturalOrder = Object.keys(themes).map(Number).sort((a, b) => a - b);
                data.order.themes[subjectId] = naturalOrder;
                return naturalOrder;
            }
            // Retorna a ordem do JSON, filtrando IDs que não existem mais e adicionando novos
            const existingIds = Object.keys(themes).map(Number);
            const savedOrder = data.order.themes[subjectId].filter(id => existingIds.includes(id));
            // Adicionar IDs novos que não estão na ordem salva
            existingIds.forEach(id => {
                if (!savedOrder.includes(id)) {
                    savedOrder.push(id);
                }
            });
            // Atualizar a ordem no JSON
            data.order.themes[subjectId] = savedOrder;
            return savedOrder;
        }

        function getOrderedModuleIndices(subjectId, themeId) {
            initializeOrder();
            const modules = data.trainingData[subjectId]?.themes[themeId]?.modules || [];
            const moduleKey = `${subjectId}_${themeId}`;
            // Sempre usar a ordem do JSON
            if (!data.order.modules[moduleKey] || data.order.modules[moduleKey].length === 0) {
                const naturalOrder = modules.map((_, i) => i);
                data.order.modules[moduleKey] = naturalOrder;
                return naturalOrder;
            }
            // Retorna a ordem do JSON, filtrando índices inválidos e ajustando
            const savedOrder = data.order.modules[moduleKey].filter(idx => idx >= 0 && idx < modules.length);
            // Garantir que todos os índices estejam na ordem
            for (let i = 0; i < modules.length; i++) {
                if (!savedOrder.includes(i)) {
                    savedOrder.push(i);
                }
            }
            // Atualizar a ordem no JSON
            data.order.modules[moduleKey] = savedOrder;
            return savedOrder;
        }

        function getOrderedQuizIndices(subjectId, themeId) {
            initializeOrder();
            const quizKey = `${subjectId}_${themeId}`;
            const quizzes = data.quizData[quizKey] || [];
            // Sempre usar a ordem do JSON
            if (!data.order.quizzes[quizKey] || data.order.quizzes[quizKey].length === 0) {
                const naturalOrder = quizzes.map((_, i) => i);
                data.order.quizzes[quizKey] = naturalOrder;
                return naturalOrder;
            }
            // Retorna a ordem do JSON, filtrando índices inválidos e ajustando
            const savedOrder = data.order.quizzes[quizKey].filter(idx => idx >= 0 && idx < quizzes.length);
            // Garantir que todos os índices estejam na ordem
            for (let i = 0; i < quizzes.length; i++) {
                if (!savedOrder.includes(i)) {
                    savedOrder.push(i);
                }
            }
            // Atualizar a ordem no JSON
            data.order.quizzes[quizKey] = savedOrder;
            return savedOrder;
        }

        function initializeOrder() {
            // Garantir que data.order existe
            if (!data.order) {
                data.order = {
                    subjects: [],
                    themes: {},
                    modules: {},
                    quizzes: {}
                };
            }
            if (!data.order.subjects) data.order.subjects = [];
            if (!data.order.themes) data.order.themes = {};
            if (!data.order.modules) data.order.modules = {};
            if (!data.order.quizzes) data.order.quizzes = {};
            
            // Inicializar ordem de subjects se necessário (mas não sobrescrever se já existir)
            if (data.trainingData && Object.keys(data.trainingData).length > 0) {
                const existingIds = Object.keys(data.trainingData).map(Number);
                if (data.order.subjects.length === 0) {
                    // Se não há ordem, criar com ordem natural
                    data.order.subjects = existingIds.sort((a, b) => a - b);
                } else {
                    // Se há ordem, garantir que todos os IDs existentes estejam nela
                    const missingIds = existingIds.filter(id => !data.order.subjects.includes(id));
                    if (missingIds.length > 0) {
                        data.order.subjects = [...data.order.subjects, ...missingIds];
                    }
                }
            }
        }

        async function moveSubject(id, direction) {
            initializeOrder();
            // Usar a ordem do JSON
            let orderedIds = [...data.order.subjects];
            const currentIndex = orderedIds.indexOf(Number(id));
            if (currentIndex === -1) {
                // Se não estiver na ordem, adicionar
                orderedIds.push(Number(id));
                const newIndex = orderedIds.length - 1;
                if (newIndex === 0) return false;
                [orderedIds[newIndex - 1], orderedIds[newIndex]] = [orderedIds[newIndex], orderedIds[newIndex - 1]];
            } else {
                const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                if (newIndex < 0 || newIndex >= orderedIds.length) return false;
                [orderedIds[currentIndex], orderedIds[newIndex]] = [orderedIds[newIndex], orderedIds[currentIndex]];
            }
            
            // Atualizar a ordem no JSON
            data.order.subjects = orderedIds;
            
            // Salvar no JSON
            if (await saveData()) {
                populateSubjectSelects();
                populateSubjects();
                showWarning('Ordem dos temas atualizada e salva no JSON!');
                return true;
            }
            return false;
        }

        async function moveTheme(subjectId, themeId, direction) {
            initializeOrder();
            // Garantir que a ordem existe
            if (!data.order.themes[subjectId]) {
                data.order.themes[subjectId] = getOrderedThemeIds(subjectId);
            }
            // Usar a ordem do JSON
            let orderedIds = [...data.order.themes[subjectId]];
            const currentIndex = orderedIds.indexOf(Number(themeId));
            if (currentIndex === -1) {
                // Se não estiver na ordem, adicionar
                orderedIds.push(Number(themeId));
                const newIndex = orderedIds.length - 1;
                if (newIndex === 0) return false;
                [orderedIds[newIndex - 1], orderedIds[newIndex]] = [orderedIds[newIndex], orderedIds[newIndex - 1]];
            } else {
                const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                if (newIndex < 0 || newIndex >= orderedIds.length) return false;
                [orderedIds[currentIndex], orderedIds[newIndex]] = [orderedIds[newIndex], orderedIds[currentIndex]];
            }
            
            // Atualizar a ordem no JSON
            data.order.themes[subjectId] = orderedIds;
            
            // Salvar no JSON
            if (await saveData()) {
                populateModuleThemes();
                populateQuizThemes();
                populateThemes();
                showWarning('Ordem dos assuntos atualizada e salva no JSON!');
                return true;
            }
            return false;
        }

        async function moveModule(subjectId, themeId, index, direction) {
            initializeOrder();
            const moduleKey = `${subjectId}_${themeId}`;
            // Garantir que a ordem existe
            if (!data.order.modules[moduleKey]) {
                data.order.modules[moduleKey] = getOrderedModuleIndices(subjectId, themeId);
            }
            // Usar a ordem do JSON
            let orderedIndices = [...data.order.modules[moduleKey]];
            const currentIndex = orderedIndices.indexOf(index);
            if (currentIndex === -1) return false;
            
            const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (newIndex < 0 || newIndex >= orderedIndices.length) return false;
            
            // Mover no array de módulos (usar os índices da ordem)
            const modules = data.trainingData[subjectId].themes[themeId].modules;
            const oldIndex = orderedIndices[currentIndex];
            const newIndexValue = orderedIndices[newIndex];
            [modules[oldIndex], modules[newIndexValue]] = [modules[newIndexValue], modules[oldIndex]];
            
            // Atualizar ordem no JSON
            [orderedIndices[currentIndex], orderedIndices[newIndex]] = [orderedIndices[newIndex], orderedIndices[currentIndex]];
            data.order.modules[moduleKey] = orderedIndices;
            
            // Salvar no JSON
            if (await saveData()) {
                populateModules();
                showWarning('Ordem dos módulos atualizada e salva no JSON!');
                return true;
            }
            return false;
        }

        async function moveQuiz(subjectId, themeId, index, direction) {
            initializeOrder();
            const quizKey = `${subjectId}_${themeId}`;
            // Garantir que a ordem existe
            if (!data.order.quizzes[quizKey]) {
                data.order.quizzes[quizKey] = getOrderedQuizIndices(subjectId, themeId);
            }
            // Usar a ordem do JSON
            let orderedIndices = [...data.order.quizzes[quizKey]];
            const currentIndex = orderedIndices.indexOf(index);
            if (currentIndex === -1) return false;
            
            const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (newIndex < 0 || newIndex >= orderedIndices.length) return false;
            
            // Mover no array de quizzes (usar os índices da ordem)
            const quizzes = data.quizData[quizKey];
            const oldIndex = orderedIndices[currentIndex];
            const newIndexValue = orderedIndices[newIndex];
            [quizzes[oldIndex], quizzes[newIndexValue]] = [quizzes[newIndexValue], quizzes[oldIndex]];
            
            // Atualizar ordem no JSON
            [orderedIndices[currentIndex], orderedIndices[newIndex]] = [orderedIndices[newIndex], orderedIndices[currentIndex]];
            data.order.quizzes[quizKey] = orderedIndices;
            
            // Salvar no JSON
            if (await saveData()) {
                populateQuizzes();
                showWarning('Ordem das questões atualizada e salva no JSON!');
                return true;
            }
            return false;
        }

        // Gerenciamento de abas
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                if (!currentBinId) {
                    showWarning('Selecione uma categoria antes de continuar.');
                    return;
                }
                // Remover active de todos os botões e conteúdos
                tabButtons.forEach(b => {
                    b.classList.remove('active');
                });
                tabContents.forEach(c => {
                    c.classList.remove('active');
                });
                // Adicionar active apenas no botão e conteúdo selecionados
                btn.classList.add('active');
                const targetTab = document.getElementById(`${btn.dataset.tab}-tab`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                // Popular dados da aba selecionada
                if (btn.dataset.tab === 'subjects') populateSubjects();
                if (btn.dataset.tab === 'themes') populateThemes();
                if (btn.dataset.tab === 'modules') populateModules();
                if (btn.dataset.tab === 'quizzes') populateQuizzes();
            });
        });

        // Aba de Temas
        const subjectNameInput = document.getElementById('subject-name');
        const subjectSaveBtn = document.getElementById('subject-save');
        const subjectDeleteBtn = document.getElementById('subject-delete');
        const subjectsContainer = document.getElementById('subjects-container');

        function populateSubjectSelects() {
            const selects = [
                document.getElementById('theme-subject'),
                document.getElementById('module-subject'),
                document.getElementById('quiz-subject')
            ];
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione um tema</option>';
                Object.keys(data.trainingData).forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = data.trainingData[id].name;
                    select.appendChild(option);
                });
            });
        }

        function populateSubjects() {
            if (!subjectsContainer) {
                console.error('subjectsContainer não encontrado');
                return;
            }
            subjectsContainer.innerHTML = '';
            
            // Verificar se há dados
            if (!data.trainingData || Object.keys(data.trainingData).length === 0) {
                console.log('Nenhum tema encontrado');
                return;
            }
            
            initializeOrder();
            let orderedIds = getOrderedIds(data.trainingData);
            
            // Verificar se há IDs ordenados
            if (!orderedIds || orderedIds.length === 0) {
                console.log('Nenhum ID ordenado encontrado, usando ordem natural');
                // Usar ordem natural se não houver ordem salva
                const naturalOrder = Object.keys(data.trainingData).map(Number).sort((a, b) => a - b);
                if (naturalOrder.length > 0) {
                    orderedIds = naturalOrder;
                    if (data.order) {
                        data.order.subjects = naturalOrder;
                    }
                } else {
                    return;
                }
            }
            
            orderedIds.forEach((id, index) => {
                const subject = data.trainingData[id];
                if (!subject) {
                    console.warn(`Tema com ID ${id} não encontrado`);
                    return;
                }
                const card = document.createElement('div');
                card.className = 'subject-card';
                const isFirst = index === 0;
                const isLast = index === orderedIds.length - 1;
                card.innerHTML = `
                    <h3>${subject.name}</h3>
                    <div class="order-buttons">
                        <button class="order-btn" data-id="${id}" data-direction="up" ${isFirst ? 'disabled' : ''}>
                            <i class="fas fa-arrow-up"></i> Cima
                        </button>
                        <button class="order-btn" data-id="${id}" data-direction="down" ${isLast ? 'disabled' : ''}>
                            <i class="fas fa-arrow-down"></i> Baixo
                        </button>
                    </div>
                    <div class="card-actions">
                        <button class="edit-subject" data-id="${id}">Editar</button>
                        <button class="delete-subject delete" data-id="${id}">Excluir</button>
                    </div>
                `;
                subjectsContainer.appendChild(card);
            });
            subjectsContainer.querySelectorAll('.edit-subject').forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log('Editando tema:', btn.dataset.id);
                    currentSubjectId = btn.dataset.id;
                    subjectNameInput.value = data.trainingData[currentSubjectId].name;
                    subjectDeleteBtn.style.display = 'block';
                });
            });
            subjectsContainer.querySelectorAll('.delete-subject').forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log('Tentando excluir tema:', btn.dataset.id);
                    deleteSubject(btn.dataset.id);
                });
            });
            subjectsContainer.querySelectorAll('.order-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    const direction = btn.dataset.direction;
                    await moveSubject(id, direction);
                });
            });
        }

        async function deleteSubject(id) {
            console.log('Iniciando exclusão do tema:', id);
            if (!data.trainingData[id]) {
                console.error('Tema não encontrado:', id);
                showWarning('Tema não encontrado.');
                return;
            }
            if (Object.keys(data.trainingData[id].themes).length > 0) {
                console.warn('Tema contém assuntos:', Object.keys(data.trainingData[id].themes));
                showWarning('Não é possível excluir o tema porque ele contém assuntos.');
                return;
            }
            if (confirm(`Tem certeza que deseja excluir o tema "${data.trainingData[id].name}"?`)) {
                showSpinner('subject-loading', true);
                try {
                    initializeOrder();
                    delete data.trainingData[id];
                    // Remover da ordem
                    if (data.order.subjects) {
                        data.order.subjects = data.order.subjects.filter(subId => subId !== Number(id));
                    }
                    // Remover ordem de temas relacionados
                    if (data.order.themes[id]) {
                        delete data.order.themes[id];
                    }
                    Object.keys(data.quizData).forEach(key => {
                        if (key.startsWith(`${id}_`)) delete data.quizData[key];
                    });
                    if (await saveData()) {
                        console.log('Tema excluído com sucesso:', id);
                        currentSubjectId = null;
                        subjectNameInput.value = '';
                        subjectDeleteBtn.style.display = 'none';
                        populateSubjectSelects();
                        populateSubjects();
                        showWarning('Tema excluído com sucesso!');
                    } else {
                        console.error('Falha ao salvar exclusão do tema:', id);
                    }
                } catch (error) {
                    console.error('Erro ao excluir tema:', error.message);
                    showWarning('Erro ao excluir tema. Tente novamente.');
                } finally {
                    showSpinner('subject-loading', false);
                }
            } else {
                console.log('Exclusão do tema cancelada:', id);
            }
        }

        subjectSaveBtn.addEventListener('click', async () => {
            const name = subjectNameInput.value.trim();
            if (!name) {
                showWarning('Por favor, insira o nome do tema.');
                return;
            }
            showSpinner('subject-loading', true);
            const id = currentSubjectId || getNextId(data.trainingData);
            const isNew = !currentSubjectId;
            data.trainingData[id] = { name, themes: data.trainingData[id]?.themes || {} };
            initializeOrder();
            if (isNew && !data.order.subjects.includes(Number(id))) {
                data.order.subjects.push(Number(id));
            }
            try {
                if (await saveData()) {
                    console.log('Tema salvo:', id);
                    currentSubjectId = null;
                    subjectNameInput.value = '';
                    subjectDeleteBtn.style.display = 'none';
                    populateSubjectSelects();
                    populateSubjects();
                    showWarning('Tema salvo com sucesso!');
                } else {
                    console.error('Falha ao salvar tema:', id);
                }
            } catch (error) {
                console.error('Erro ao salvar tema:', error.message);
                showWarning('Erro ao salvar tema. Tente novamente.');
            } finally {
                showSpinner('subject-loading', false);
            }
        });

        subjectDeleteBtn.addEventListener('click', () => {
            if (currentSubjectId) {
                console.log('Botão de exclusão do formulário clicado para tema:', currentSubjectId);
                deleteSubject(currentSubjectId);
            } else {
                console.warn('Nenhum tema selecionado para exclusão');
                showWarning('Selecione um tema para excluir.');
            }
        });

        // Aba de Assuntos
        const themeSubjectSelect = document.getElementById('theme-subject');
        const themeNameInput = document.getElementById('theme-name');
        const themeSaveBtn = document.getElementById('theme-save');
        const themeDeleteBtn = document.getElementById('theme-delete');
        const themesContainer = document.getElementById('themes-container');

        themeSubjectSelect.addEventListener('change', () => {
            currentThemeId = null;
            themeNameInput.value = '';
            themeDeleteBtn.style.display = 'none';
            document.getElementById('theme-migrate-container').classList.remove('active');
            populateModuleThemes();
            populateQuizThemes();
            populateThemes();
        });

        function populateThemes() {
            themesContainer.innerHTML = '';
            const subjectId = themeSubjectSelect.value;
            if (!subjectId || !data.trainingData[subjectId]) return;
            initializeOrder();
            const orderedIds = getOrderedThemeIds(subjectId);
            orderedIds.forEach((id, index) => {
                const theme = data.trainingData[subjectId].themes[id];
                const card = document.createElement('div');
                card.className = 'theme-card';
                const isFirst = index === 0;
                const isLast = index === orderedIds.length - 1;
                card.innerHTML = `
                    <h3>${theme.name}</h3>
                    <div class="order-buttons">
                        <button class="order-btn" data-id="${id}" data-direction="up" ${isFirst ? 'disabled' : ''}>
                            <i class="fas fa-arrow-up"></i> Cima
                        </button>
                        <button class="order-btn" data-id="${id}" data-direction="down" ${isLast ? 'disabled' : ''}>
                            <i class="fas fa-arrow-down"></i> Baixo
                        </button>
                    </div>
                    <div class="card-actions">
                        <button class="edit-theme" data-id="${id}">Editar</button>
                        <button class="delete-theme delete" data-id="${id}">Excluir</button>
                    </div>
                `;
                themesContainer.appendChild(card);
            });
            themesContainer.querySelectorAll('.edit-theme').forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log('Editando assunto:', btn.dataset.id);
                    currentThemeId = btn.dataset.id;
                    themeNameInput.value = data.trainingData[themeSubjectSelect.value].themes[currentThemeId].name;
                    themeDeleteBtn.style.display = 'block';
                    // Mostrar container de migração e preencher select
                    const migrateContainer = document.getElementById('theme-migrate-container');
                    const newSubjectSelect = document.getElementById('theme-new-subject');
                    migrateContainer.classList.add('active');
                    newSubjectSelect.innerHTML = '<option value="">Selecione o novo tema</option>';
                    Object.keys(data.trainingData).forEach(id => {
                        if (id !== themeSubjectSelect.value) {
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = data.trainingData[id].name;
                            newSubjectSelect.appendChild(option);
                        }
                    });
                });
            });
            themesContainer.querySelectorAll('.delete-theme').forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log('Tentando excluir assunto:', btn.dataset.id);
                    deleteTheme(themeSubjectSelect.value, btn.dataset.id);
                });
            });
            themesContainer.querySelectorAll('.order-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    const direction = btn.dataset.direction;
                    await moveTheme(themeSubjectSelect.value, id, direction);
                });
            });
        }

        async function deleteTheme(subjectId, id) {
            console.log('Iniciando exclusão do assunto:', id, 'do tema:', subjectId);
            if (!data.trainingData[subjectId]?.themes[id]) {
                console.error('Assunto não encontrado:', id);
                showWarning('Assunto não encontrado.');
                return;
            }
            if (data.trainingData[subjectId].themes[id].modules?.length > 0) {
                console.warn('Assunto contém módulos:', data.trainingData[subjectId].themes[id].modules);
                showWarning('Não é possível excluir o assunto porque ele contém módulos.');
                return;
            }
            if (confirm(`Tem certeza que deseja excluir o assunto "${data.trainingData[subjectId].themes[id].name}"?`)) {
                showSpinner('theme-loading', true);
                try {
                    initializeOrder();
                    delete data.trainingData[subjectId].themes[id];
                    // Remover da ordem
                    if (data.order.themes[subjectId]) {
                        data.order.themes[subjectId] = data.order.themes[subjectId].filter(themeId => themeId !== Number(id));
                    }
                    // Remover ordem de módulos relacionados
                    const moduleKey = `${subjectId}_${id}`;
                    if (data.order.modules[moduleKey]) {
                        delete data.order.modules[moduleKey];
                    }
                    delete data.quizData[`${subjectId}_${id}`];
                    if (await saveData()) {
                        console.log('Assunto excluído com sucesso:', id);
                        currentThemeId = null;
                        themeNameInput.value = '';
                        themeDeleteBtn.style.display = 'none';
                        document.getElementById('theme-migrate-container').classList.remove('active');
                        populateModuleThemes();
                        populateQuizThemes();
                        populateThemes();
                        showWarning('Assunto excluído com sucesso!');
                    } else {
                        console.error('Falha ao salvar exclusão do assunto:', id);
                    }
                } catch (error) {
                    console.error('Erro ao excluir assunto:', error.message);
                    showWarning('Erro ao excluir assunto. Tente novamente.');
                } finally {
                    showSpinner('theme-loading', false);
                }
            } else {
                console.log('Exclusão do assunto cancelada:', id);
            }
        }

        async function migrateTheme(oldSubjectId, themeId, newSubjectId) {
            console.log('Iniciando migração do assunto:', themeId, 'do tema:', oldSubjectId, 'para o tema:', newSubjectId);
            if (!data.trainingData[oldSubjectId]?.themes[themeId]) {
                console.error('Assunto não encontrado:', themeId);
                showWarning('Assunto não encontrado.');
                return false;
            }
            if (!data.trainingData[newSubjectId]) {
                console.error('Novo tema não encontrado:', newSubjectId);
                showWarning('Novo tema não encontrado.');
                return false;
            }
            if (oldSubjectId === newSubjectId) {
                showWarning('O assunto já está neste tema.');
                return false;
            }
            if (confirm(`Tem certeza que deseja migrar o assunto "${data.trainingData[oldSubjectId].themes[themeId].name}" e todos os seus módulos e avaliações para o tema "${data.trainingData[newSubjectId].name}"?`)) {
                showSpinner('theme-loading', true);
                try {
                    initializeOrder();
                    // Copiar o assunto completo (incluindo módulos)
                    const themeData = { ...data.trainingData[oldSubjectId].themes[themeId] };
                    const newThemeId = getNextId(data.trainingData[newSubjectId].themes);
                    
                    // Adicionar o assunto no novo tema
                    data.trainingData[newSubjectId].themes[newThemeId] = themeData;
                    
                    // Atualizar ordem de temas
                    if (!data.order.themes[newSubjectId]) {
                        data.order.themes[newSubjectId] = [];
                    }
                    data.order.themes[newSubjectId].push(Number(newThemeId));
                    
                    // Remover da ordem do tema antigo
                    if (data.order.themes[oldSubjectId]) {
                        data.order.themes[oldSubjectId] = data.order.themes[oldSubjectId].filter(id => id !== Number(themeId));
                    }
                    
                    // Migrar as avaliações (quizData)
                    const oldQuizKey = `${oldSubjectId}_${themeId}`;
                    const newQuizKey = `${newSubjectId}_${newThemeId}`;
                    if (data.quizData[oldQuizKey]) {
                        data.quizData[newQuizKey] = [...data.quizData[oldQuizKey]];
                        // Migrar ordem de quizzes
                        if (data.order.quizzes[oldQuizKey]) {
                            data.order.quizzes[newQuizKey] = [...data.order.quizzes[oldQuizKey]];
                            delete data.order.quizzes[oldQuizKey];
                        }
                        delete data.quizData[oldQuizKey];
                        console.log(`Avaliações migradas de ${oldQuizKey} para ${newQuizKey}`);
                    }
                    
                    // Migrar ordem de módulos
                    const oldModuleKey = `${oldSubjectId}_${themeId}`;
                    const newModuleKey = `${newSubjectId}_${newThemeId}`;
                    if (data.order.modules[oldModuleKey]) {
                        data.order.modules[newModuleKey] = [...data.order.modules[oldModuleKey]];
                        delete data.order.modules[oldModuleKey];
                    }
                    
                    // Remover o assunto do tema antigo
                    delete data.trainingData[oldSubjectId].themes[themeId];
                    
                    if (await saveData()) {
                        console.log('Assunto migrado com sucesso:', themeId, 'para', newThemeId);
                        showWarning(`Assunto migrado com sucesso para "${data.trainingData[newSubjectId].name}"!`);
                        
                        // Atualizar a interface
                        currentThemeId = null;
                        themeNameInput.value = '';
                        themeDeleteBtn.style.display = 'none';
                        document.getElementById('theme-migrate-container').classList.remove('active');
                        populateSubjectSelects();
                        populateModuleThemes();
                        populateQuizThemes();
                        populateThemes();
                        return true;
                    } else {
                        console.error('Falha ao salvar migração do assunto:', themeId);
                        showWarning('Falha ao salvar migração do assunto.');
                        return false;
                    }
                } catch (error) {
                    console.error('Erro ao migrar assunto:', error.message);
                    showWarning(`Erro ao migrar assunto: ${error.message}`);
                    return false;
                } finally {
                    showSpinner('theme-loading', false);
                }
            } else {
                console.log('Migração do assunto cancelada:', themeId);
                return false;
            }
        }

        themeSaveBtn.addEventListener('click', async () => {
            const subjectId = themeSubjectSelect.value;
            if (!subjectId) {
                showWarning('Por favor, selecione um tema.');
                return;
            }
            const name = themeNameInput.value.trim();
            if (!name) {
                showWarning('Por favor, insira o nome do assunto.');
                return;
            }
            showSpinner('theme-loading', true);
            const id = currentThemeId || getNextId(data.trainingData[subjectId].themes);
            const isNew = !currentThemeId;
            data.trainingData[subjectId].themes[id] = { name, modules: data.trainingData[subjectId].themes[id]?.modules || [] };
            initializeOrder();
            if (!data.order.themes[subjectId]) {
                data.order.themes[subjectId] = [];
            }
            if (isNew && !data.order.themes[subjectId].includes(Number(id))) {
                data.order.themes[subjectId].push(Number(id));
            }
            try {
                if (await saveData()) {
                    console.log('Assunto salvo:', id);
                    currentThemeId = null;
                    themeNameInput.value = '';
                    themeDeleteBtn.style.display = 'none';
                    document.getElementById('theme-migrate-container').classList.remove('active');
                    populateModuleThemes();
                    populateQuizThemes();
                    populateThemes();
                    showWarning('Assunto salvo com sucesso!');
                } else {
                    console.error('Falha ao salvar assunto:', id);
                }
            } catch (error) {
                console.error('Erro ao salvar assunto:', error.message);
                showWarning('Erro ao salvar assunto. Tente novamente.');
            } finally {
                showSpinner('theme-loading', false);
            }
        });

        themeDeleteBtn.addEventListener('click', () => {
            const subjectId = themeSubjectSelect.value;
            if (!subjectId || !currentThemeId) {
                console.warn('Nenhum tema ou assunto selecionado para exclusão');
                showWarning('Selecione um tema e um assunto para excluir.');
                return;
            }
            console.log('Botão de exclusão do formulário clicado para assunto:', currentThemeId);
            deleteTheme(subjectId, currentThemeId);
        });

        document.getElementById('theme-migrate').addEventListener('click', async () => {
            const oldSubjectId = themeSubjectSelect.value;
            const newSubjectId = document.getElementById('theme-new-subject').value;
            if (!oldSubjectId || !newSubjectId || !currentThemeId) {
                showWarning('Por favor, selecione um tema e um assunto para migrar, e escolha o novo tema de destino.');
                return;
            }
            await migrateTheme(oldSubjectId, currentThemeId, newSubjectId);
        });

        // Aba de Módulos
        const moduleSubjectSelect = document.getElementById('module-subject');
        const moduleThemeSelect = document.getElementById('module-theme');
        const moduleTitleInput = document.getElementById('module-title');
        const moduleCaptionInput = document.getElementById('module-caption');
        const moduleVideoInput = document.getElementById('module-video');
        const modulePdfInput = document.getElementById('module-pdf');
        const moduleAttachmentsInput = document.getElementById('module-attachments');
        const moduleSaveBtn = document.getElementById('module-save');
        const moduleDeleteBtn = document.getElementById('module-delete');
        const modulesContainer = document.getElementById('modules-container');

        function populateModuleThemes() {
            const subjectId = moduleSubjectSelect.value;
            moduleThemeSelect.innerHTML = '<option value="">Selecione um assunto</option>';
            if (subjectId && data.trainingData[subjectId]) {
                Object.keys(data.trainingData[subjectId].themes).forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = data.trainingData[subjectId].themes[id].name;
                    moduleThemeSelect.appendChild(option);
                });
            }
            populateModules();
        }

        moduleSubjectSelect.addEventListener('change', populateModuleThemes);
        moduleThemeSelect.addEventListener('change', populateModules);

        function populateModules() {
            modulesContainer.innerHTML = '';
            const subjectId = moduleSubjectSelect.value;
            const themeId = moduleThemeSelect.value;
            if (!subjectId || !themeId || !data.trainingData[subjectId]?.themes[themeId]) return;
            initializeOrder();
            const modules = data.trainingData[subjectId].themes[themeId].modules || [];
            const orderedIndices = getOrderedModuleIndices(subjectId, themeId);
            orderedIndices.forEach((originalIndex, displayIndex) => {
                const mod = modules[originalIndex];
                const card = document.createElement('div');
                card.className = 'module-card';
                const isFirst = displayIndex === 0;
                const isLast = displayIndex === orderedIndices.length - 1;
                card.innerHTML = `
                    <h3>${mod.title}</h3>
                    <p>${mod.caption || 'Sem subtítulo'}</p>
                    <div class="order-buttons">
                        <button class="order-btn" data-index="${originalIndex}" data-direction="up" ${isFirst ? 'disabled' : ''}>
                            <i class="fas fa-arrow-up"></i> Cima
                        </button>
                        <button class="order-btn" data-index="${originalIndex}" data-direction="down" ${isLast ? 'disabled' : ''}>
                            <i class="fas fa-arrow-down"></i> Baixo
                        </button>
                    </div>
                    <div class="card-actions">
                        <button class="edit-module" data-index="${originalIndex}">Editar</button>
                        <button class="delete-module delete" data-index="${originalIndex}">Excluir</button>
                    </div>
                `;
                modulesContainer.appendChild(card);
            });
            modulesContainer.querySelectorAll('.edit-module').forEach(btn => {
                btn.addEventListener('click', () => {
                    const originalIndex = parseInt(btn.dataset.index);
                    console.log('Editando módulo:', originalIndex);
                    currentModuleIndex = originalIndex;
                    const mod = data.trainingData[subjectId].themes[themeId].modules[originalIndex];
                    moduleTitleInput.value = mod.title;
                    moduleCaptionInput.value = mod.caption || '';
                    moduleVideoInput.value = mod.videoId || '';
                    modulePdfInput.value = mod.pdfUrl || '';
                    moduleAttachmentsInput.value = mod.attachments?.map(a => `${a.title};${a.url}`).join('\n') || '';
                    moduleDeleteBtn.style.display = 'block';
                });
            });
            modulesContainer.querySelectorAll('.delete-module').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const originalIndex = parseInt(btn.dataset.index);
                    console.log('Tentando excluir módulo:', originalIndex);
                    if (confirm(`Tem certeza que deseja excluir o módulo "${data.trainingData[subjectId].themes[themeId].modules[originalIndex].title}"?`)) {
                        showSpinner('module-loading', true);
                        try {
                            initializeOrder();
                            const moduleKey = `${subjectId}_${themeId}`;
                            // Remover da ordem
                            if (data.order.modules[moduleKey]) {
                                const orderIndex = data.order.modules[moduleKey].indexOf(originalIndex);
                                if (orderIndex !== -1) {
                                    data.order.modules[moduleKey].splice(orderIndex, 1);
                                    // Ajustar índices maiores
                                    data.order.modules[moduleKey] = data.order.modules[moduleKey].map(idx => idx > originalIndex ? idx - 1 : idx);
                                }
                            }
                            data.trainingData[subjectId].themes[themeId].modules.splice(originalIndex, 1);
                            if (await saveData()) {
                                console.log('Módulo excluído com sucesso:', originalIndex);
                                currentModuleIndex = null;
                                moduleTitleInput.value = '';
                                moduleCaptionInput.value = '';
                                moduleVideoInput.value = '';
                                modulePdfInput.value = '';
                                moduleAttachmentsInput.value = '';
                                moduleDeleteBtn.style.display = 'none';
                                populateModules();
                                showWarning('Módulo excluído com sucesso!');
                            } else {
                                console.error('Falha ao salvar exclusão do módulo:', index);
                                showWarning('Falha ao salvar exclusão do módulo. Estado local atualizado.');
                                populateModules(); // Atualiza interface mesmo com falha
                            }
                        } catch (error) {
                            console.error('Erro ao excluir módulo:', error.message);
                            showWarning(`Erro ao excluir módulo: ${error.message}`);
                            populateModules(); // Atualiza interface mesmo com erro
                        } finally {
                            showSpinner('module-loading', false);
                        }
                    } else {
                        console.log('Exclusão do módulo cancelada:', originalIndex);
                    }
                });
            });
            modulesContainer.querySelectorAll('.order-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const originalIndex = parseInt(btn.dataset.index);
                    const direction = btn.dataset.direction;
                    await moveModule(subjectId, themeId, originalIndex, direction);
                });
            });
        }

        moduleSaveBtn.addEventListener('click', async () => {
            const subjectId = moduleSubjectSelect.value;
            const themeId = moduleThemeSelect.value;
            if (!subjectId || !themeId) {
                showWarning('Por favor, selecione tema e assunto.');
                return;
            }
            const title = moduleTitleInput.value.trim();
            if (!title) {
                showWarning('Por favor, insira o título do módulo.');
                return;
            }
            const attachments = moduleAttachmentsInput.value.trim().split('\n').filter(line => line).map(line => {
                const [title, url] = line.split(';');
                return { title: title?.trim(), url: url?.trim() };
            }).filter(a => a.title && a.url);
            const module = {
                title,
                caption: moduleCaptionInput.value.trim() || undefined,
                videoId: moduleVideoInput.value.trim() || undefined,
                pdfUrl: modulePdfInput.value.trim() || undefined,
                attachments: attachments.length ? attachments : []
            };
            showSpinner('module-loading', true);
            const modules = data.trainingData[subjectId].themes[themeId].modules || [];
            const isNew = currentModuleIndex === null;
            initializeOrder();
            const moduleKey = `${subjectId}_${themeId}`;
            if (currentModuleIndex !== null) {
                modules[currentModuleIndex] = module;
            } else {
                const newIndex = modules.length;
                modules.push(module);
                // Adicionar à ordem
                if (!data.order.modules[moduleKey]) {
                    data.order.modules[moduleKey] = [];
                }
                if (isNew && !data.order.modules[moduleKey].includes(newIndex)) {
                    data.order.modules[moduleKey].push(newIndex);
                }
            }
            data.trainingData[subjectId].themes[themeId].modules = modules;
            try {
                if (await saveData()) {
                    console.log('Módulo salvo:', currentModuleIndex !== null ? currentModuleIndex : 'novo');
                    currentModuleIndex = null;
                    moduleTitleInput.value = '';
                    moduleCaptionInput.value = '';
                    moduleVideoInput.value = '';
                    modulePdfInput.value = '';
                    moduleAttachmentsInput.value = '';
                    moduleDeleteBtn.style.display = 'none';
                    populateModules();
                    showWarning('Módulo salvo com sucesso!');
                } else {
                    console.error('Falha ao salvar módulo');
                    showWarning('Falha ao salvar módulo. Estado local atualizado.');
                    populateModules();
                }
            } catch (error) {
                console.error('Erro ao salvar módulo:', error.message);
                showWarning(`Erro ao salvar módulo: ${error.message}`);
                populateModules();
            } finally {
                showSpinner('module-loading', false);
            }
        });

        moduleDeleteBtn.addEventListener('click', async () => {
            const subjectId = moduleSubjectSelect.value;
            const themeId = moduleThemeSelect.value;
            if (!subjectId || !themeId || currentModuleIndex === null) {
                console.warn('Nenhum tema, assunto ou módulo selecionado para exclusão');
                showWarning('Selecione um tema, assunto e módulo para excluir.');
                return;
            }
            console.log('Botão de exclusão do formulário clicado para módulo:', currentModuleIndex);
            if (confirm(`Tem certeza que deseja excluir o módulo "${data.trainingData[subjectId].themes[themeId].modules[currentModuleIndex].title}"?`)) {
                showSpinner('module-loading', true);
                try {
                    data.trainingData[subjectId].themes[themeId].modules.splice(currentModuleIndex, 1);
                    if (await saveData()) {
                        console.log('Módulo excluído com sucesso:', currentModuleIndex);
                        currentModuleIndex = null;
                        moduleTitleInput.value = '';
                        moduleCaptionInput.value = '';
                        moduleVideoInput.value = '';
                        modulePdfInput.value = '';
                        moduleAttachmentsInput.value = '';
                        moduleDeleteBtn.style.display = 'none';
                        populateModules();
                        showWarning('Módulo excluído com sucesso!');
                    } else {
                        console.error('Falha ao salvar exclusão do módulo:', currentModuleIndex);
                        showWarning('Falha ao salvar exclusão do módulo. Estado local atualizado.');
                        populateModules();
                    }
                } catch (error) {
                    console.error('Erro ao excluir módulo:', error.message);
                    showWarning(`Erro ao excluir módulo: ${error.message}`);
                    populateModules();
                } finally {
                    showSpinner('module-loading', false);
                }
            } else {
                console.log('Exclusão do módulo cancelada:', currentModuleIndex);
            }
        });

        // Aba de Avaliações
        const quizSubjectSelect = document.getElementById('quiz-subject');
        const quizThemeSelect = document.getElementById('quiz-theme');
        const quizQuestionInput = document.getElementById('quiz-question');
        const quizOption1Input = document.getElementById('quiz-option1');
        const quizOption2Input = document.getElementById('quiz-option2');
        const quizOption3Input = document.getElementById('quiz-option3');
        const quizOption4Input = document.getElementById('quiz-option4');
        const quizCorrectSelect = document.getElementById('quiz-correct');
        const quizSaveBtn = document.getElementById('quiz-save');
        const quizDeleteBtn = document.getElementById('quiz-delete');
        const quizzesContainer = document.getElementById('quizzes-container');

        function populateQuizThemes() {
            const subjectId = quizSubjectSelect.value;
            quizThemeSelect.innerHTML = '<option value="">Selecione um assunto</option>';
            if (subjectId && data.trainingData[subjectId]) {
                Object.keys(data.trainingData[subjectId].themes).forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = data.trainingData[subjectId].themes[id].name;
                    quizThemeSelect.appendChild(option);
                });
            }
            populateQuizzes();
        }

        quizSubjectSelect.addEventListener('change', populateQuizThemes);
        quizThemeSelect.addEventListener('change', populateQuizzes);

        function populateQuizzes() {
            quizzesContainer.innerHTML = '';
            const subjectId = quizSubjectSelect.value;
            const themeId = quizThemeSelect.value;
            if (!subjectId || !themeId) {
                console.warn('Tema ou assunto não selecionado para exibir questões');
                return;
            }
            const quizKey = `${subjectId}_${themeId}`;
            if (!data.quizData[quizKey]) {
                console.log(`Nenhuma questão encontrada para quizKey: ${quizKey}`);
                return;
            }
            initializeOrder();
            const quizzes = data.quizData[quizKey];
            const orderedIndices = getOrderedQuizIndices(subjectId, themeId);
            orderedIndices.forEach((originalIndex, displayIndex) => {
                const quiz = quizzes[originalIndex];
                const card = document.createElement('div');
                card.className = 'quiz-card';
                const isFirst = displayIndex === 0;
                const isLast = displayIndex === orderedIndices.length - 1;
                card.innerHTML = `
                    <h3>${quiz.question}</h3>
                    <div class="order-buttons">
                        <button class="order-btn" data-index="${originalIndex}" data-direction="up" ${isFirst ? 'disabled' : ''}>
                            <i class="fas fa-arrow-up"></i> Cima
                        </button>
                        <button class="order-btn" data-index="${originalIndex}" data-direction="down" ${isLast ? 'disabled' : ''}>
                            <i class="fas fa-arrow-down"></i> Baixo
                        </button>
                    </div>
                    <div class="card-actions">
                        <button class="edit-quiz" data-index="${originalIndex}">Editar</button>
                        <button class="delete-quiz delete" data-index="${originalIndex}">Excluir</button>
                    </div>
                `;
                quizzesContainer.appendChild(card);
            });
            quizzesContainer.querySelectorAll('.edit-quiz').forEach(btn => {
                btn.addEventListener('click', () => {
                    const originalIndex = parseInt(btn.dataset.index);
                    console.log('Editando questão:', originalIndex);
                    currentQuizIndex = originalIndex;
                    const quiz = data.quizData[quizKey][originalIndex];
                    quizQuestionInput.value = quiz.question;
                    quizOption1Input.value = quiz.options[0];
                    quizOption2Input.value = quiz.options[1];
                    quizOption3Input.value = quiz.options[2];
                    quizOption4Input.value = quiz.options[3];
                    quizCorrectSelect.value = quiz.correct;
                    quizDeleteBtn.style.display = 'block';
                });
            });
            quizzesContainer.querySelectorAll('.delete-quiz').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const originalIndex = parseInt(btn.dataset.index);
                    console.log('Tentando excluir questão:', originalIndex, 'para quizKey:', quizKey);
                    if (!data.quizData[quizKey][originalIndex]) {
                        console.error('Questão não encontrada:', originalIndex, quizKey);
                        showWarning('Questão não encontrada.');
                        return;
                    }
                    if (confirm(`Tem certeza que deseja excluir a questão "${data.quizData[quizKey][originalIndex].question}"?`)) {
                        showSpinner('quiz-loading', true);
                        try {
                            initializeOrder();
                            // Remover da ordem
                            if (data.order.quizzes[quizKey]) {
                                const orderIndex = data.order.quizzes[quizKey].indexOf(originalIndex);
                                if (orderIndex !== -1) {
                                    data.order.quizzes[quizKey].splice(orderIndex, 1);
                                    // Ajustar índices maiores
                                    data.order.quizzes[quizKey] = data.order.quizzes[quizKey].map(idx => idx > originalIndex ? idx - 1 : idx);
                                }
                            }
                            data.quizData[quizKey].splice(originalIndex, 1);
                            if (data.quizData[quizKey].length === 0) {
                                delete data.quizData[quizKey];
                                console.log(`QuizKey ${quizKey} removido, pois estava vazio`);
                            }
                            if (await saveData()) {
                                console.log('Questão excluída com sucesso:', originalIndex, quizKey);
                                currentQuizIndex = null;
                                quizQuestionInput.value = '';
                                quizOption1Input.value = '';
                                quizOption2Input.value = '';
                                quizOption3Input.value = '';
                                quizOption4Input.value = '';
                                quizCorrectSelect.value = '0';
                                quizDeleteBtn.style.display = 'none';
                                populateQuizzes();
                                showWarning('Questão excluída com sucesso!');
                            } else {
                                console.error('Falha ao salvar exclusão da questão:', index, quizKey);
                                showWarning('Falha ao salvar exclusão da questão. Estado local atualizado.');
                                populateQuizzes();
                            }
                        } catch (error) {
                            console.error('Erro ao excluir questão:', error.message);
                            showWarning(`Erro ao excluir questão: ${error.message}`);
                            populateQuizzes();
                        } finally {
                            showSpinner('quiz-loading', false);
                        }
                    } else {
                        console.log('Exclusão da questão cancelada:', originalIndex, quizKey);
                    }
                });
            });
            quizzesContainer.querySelectorAll('.order-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const originalIndex = parseInt(btn.dataset.index);
                    const direction = btn.dataset.direction;
                    await moveQuiz(subjectId, themeId, originalIndex, direction);
                });
            });
        }

        quizSaveBtn.addEventListener('click', async () => {
            const subjectId = quizSubjectSelect.value;
            const themeId = quizThemeSelect.value;
            if (!subjectId || !themeId) {
                showWarning('Por favor, selecione tema e assunto.');
                return;
            }
            const question = quizQuestionInput.value.trim();
            const option1 = quizOption1Input.value.trim();
            const option2 = quizOption2Input.value.trim();
            const option3 = quizOption3Input.value.trim();
            const option4 = quizOption4Input.value.trim();
            const correct = parseInt(quizCorrectSelect.value);
            if (!question || !option1 || !option2 || !option3 || !option4) {
                showWarning('Por favor, preencha todos os campos da questão.');
                return;
            }
            showSpinner('quiz-loading', true);
            const quizKey = `${subjectId}_${themeId}`;
            if (!data.quizData[quizKey]) data.quizData[quizKey] = [];
            const quiz = {
                question,
                options: [option1, option2, option3, option4],
                correct
            };
            initializeOrder();
            const isNew = currentQuizIndex === null;
            try {
                if (currentQuizIndex !== null) {
                    data.quizData[quizKey][currentQuizIndex] = quiz;
                } else {
                    const newIndex = data.quizData[quizKey].length;
                    data.quizData[quizKey].push(quiz);
                    // Adicionar à ordem
                    if (!data.order.quizzes[quizKey]) {
                        data.order.quizzes[quizKey] = [];
                    }
                    if (isNew && !data.order.quizzes[quizKey].includes(newIndex)) {
                        data.order.quizzes[quizKey].push(newIndex);
                    }
                }
                if (await saveData()) {
                    console.log('Questão salva:', currentQuizIndex !== null ? currentQuizIndex : 'nova', quizKey);
                    currentQuizIndex = null;
                    quizQuestionInput.value = '';
                    quizOption1Input.value = '';
                    quizOption2Input.value = '';
                    quizOption3Input.value = '';
                    quizOption4Input.value = '';
                    quizCorrectSelect.value = '0';
                    quizDeleteBtn.style.display = 'none';
                    populateQuizzes();
                    showWarning('Questão salva com sucesso!');
                } else {
                    console.error('Falha ao salvar questão:', quizKey);
                    showWarning('Falha ao salvar questão. Estado local atualizado.');
                    populateQuizzes();
                }
            } catch (error) {
                console.error('Erro ao salvar questão:', error.message);
                showWarning(`Erro ao salvar questão: ${error.message}`);
                populateQuizzes();
            } finally {
                showSpinner('quiz-loading', false);
            }
        });

        quizDeleteBtn.addEventListener('click', async () => {
            const subjectId = quizSubjectSelect.value;
            const themeId = quizThemeSelect.value;
            const quizKey = `${subjectId}_${themeId}`;
            if (!subjectId || !themeId || currentQuizIndex === null) {
                console.warn('Nenhum tema, assunto ou questão selecionada para exclusão');
                showWarning('Selecione um tema, assunto e questão para excluir.');
                return;
            }
            console.log('Botão de exclusão do formulário clicado para questão:', currentQuizIndex, quizKey);
            if (!data.quizData[quizKey] || !data.quizData[quizKey][currentQuizIndex]) {
                console.error('Questão não encontrada:', currentQuizIndex, quizKey);
                showWarning('Questão não encontrada.');
                return;
            }
            if (confirm(`Tem certeza que deseja excluir a questão "${data.quizData[quizKey][currentQuizIndex].question}"?`)) {
                showSpinner('quiz-loading', true);
                try {
                    data.quizData[quizKey].splice(currentQuizIndex, 1);
                    if (data.quizData[quizKey].length === 0) {
                        delete data.quizData[quizKey];
                        console.log(`QuizKey ${quizKey} removido, pois estava vazio`);
                    }
                    if (await saveData()) {
                        console.log('Questão excluída com sucesso:', currentQuizIndex, quizKey);
                        currentQuizIndex = null;
                        quizQuestionInput.value = '';
                        quizOption1Input.value = '';
                        quizOption2Input.value = '';
                        quizOption3Input.value = '';
                        quizOption4Input.value = '';
                        quizCorrectSelect.value = '0';
                        quizDeleteBtn.style.display = 'none';
                        populateQuizzes();
                        showWarning('Questão excluída com sucesso!');
                    } else {
                        console.error('Falha ao salvar exclusão da questão:', currentQuizIndex, quizKey);
                        showWarning('Falha ao salvar exclusão da questão. Estado local atualizado.');
                        populateQuizzes();
                    }
                } catch (error) {
                    console.error('Erro ao excluir questão:', error.message);
                    showWarning(`Erro ao excluir questão: ${error.message}`);
                    populateQuizzes();
                } finally {
                    showSpinner('quiz-loading', false);
                }
            } else {
                console.log('Exclusão da questão cancelada:', currentQuizIndex, quizKey);
            }
        });

        // Inicialização
        window.onload = () => {
            showModal();
        };

        // Inicializar abas quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTabs);
        } else {
            initializeTabs();
        }

        document.onkeydown = function(event) {
    if (
        event.keyCode === 123 ||  // F12
        ctrlShiftKey(event, 'I') ||  // Ctrl + Shift + I
        ctrlShiftKey(event, 'J') ||  // Ctrl + Shift + J
        ctrlShiftKey(event, 'C') ||  // Ctrl + Shift + C
        (event.ctrlKey && event.keyCode === 'U'.charCodeAt(0)) ||  // Ctrl + U
        (event.ctrlKey && event.keyCode === 'S'.charCodeAt(0))  // Ctrl + S
    ) {
        event.preventDefault();
        return false;
    }
};
        document.addEventListener('contextmenu', function(evento) {
                // Previne o comportamento padrão (abre o menu)
                evento.preventDefault();
            });
    </script>
</body>
</html>
